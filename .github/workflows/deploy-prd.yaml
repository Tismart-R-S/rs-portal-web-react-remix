name: PRD Deployment

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PRD

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”„ Limpiar instalaciÃ³n previa
        run: |
          rm -rf node_modules package-lock.json
      
      - name: ğŸ” Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ğŸ”‘ Configurar credenciales de Cloudflare R2
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id=${{ secrets.R2_PRD_ACCESS_ID_KEY }}" >> ~/.aws/credentials
          echo "aws_secret_access_key=${{ secrets.R2_PRD_ACCESS_SECRET_KEY }}" >> ~/.aws/credentials

          echo "[default]" > ~/.aws/config
          echo "region=auto" >> ~/.aws/config
          echo "output=json" >> ~/.aws/config
          echo "endpoint_url=${{ secrets.R2_PRD_ENDPOINT }}" >> ~/.aws/config

      - name: ğŸ”½ Descargar archivo de configuraciÃ³n desde Cloudflare R2
        run: |
          aws s3 cp "s3://rs-config-files-prd/env-portal" .env --endpoint-url=${{ secrets.R2_PRD_ENDPOINT }}

      - name: ğŸ“ Verificar archivo descargado
        run: ls -la

      - name: ğŸ” Autenticarse en Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: ğŸ”¨ Construir y etiquetar imagen Docker
        run: |
          VERSION=$(git rev-parse --short HEAD)
          docker build -t rs:$VERSION .
          docker tag rs:$VERSION 919912553755.dkr.ecr.us-east-1.amazonaws.com/rs:prd
          docker tag rs:$VERSION 919912553755.dkr.ecr.us-east-1.amazonaws.com/rs:latest

      - name: ğŸ“¤ Subir imagen a Amazon ECR
        run: |
          docker push 919912553755.dkr.ecr.us-east-1.amazonaws.com/rs:$VERSION
          docker push 919912553755.dkr.ecr.us-east-1.amazonaws.com/rs:latest